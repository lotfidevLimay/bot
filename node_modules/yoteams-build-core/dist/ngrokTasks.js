"use strict";
// Copyright (c) Wictor WilÃ©n. All rights reserved.
// Licensed under the MIT license.
// SPDX-License-Identifier: MIT
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ngrokTasks = void 0;
const fancy_log_1 = __importDefault(require("fancy-log"));
const ngrok_1 = __importDefault(require("ngrok"));
const _1 = require(".");
const plugin_error_1 = __importDefault(require("plugin-error"));
const ngrokTasks = (gulp, config) => {
    gulp.task("start-ngrok", (cb) => {
        (0, fancy_log_1.default)("[NGROK] starting ngrok...");
        const conf = {
            subdomain: process.env.NGROK_SUBDOMAIN,
            region: process.env.NGROK_REGION,
            addr: process.env.PORT,
            authtoken: process.env.NGROK_AUTH
        };
        ngrok_1.default.connect(conf).then((url) => {
            (0, fancy_log_1.default)("[NGROK] Url: " + url);
            if (!conf.authtoken) {
                (0, fancy_log_1.default)("[NGROK] You have been assigned a random ngrok URL that will only be available for this session. You will need to re-upload the Teams manifest next time you run this command.");
            }
            let hostName = url.replace("http://", "");
            hostName = hostName.replace("https://", "");
            (0, fancy_log_1.default)("[NGROK] PUBLIC_HOSTNAME set to: " + hostName);
            process.env.PUBLIC_HOSTNAME = hostName;
            (0, fancy_log_1.default)("[NGROK] Inspect Url: " + ngrok_1.default.getUrl());
            cb();
        }).catch((err) => {
            cb(new plugin_error_1.default("yoteams-build.core", err));
        });
    });
    gulp.task("ngrok-serve", (0, _1.dependencies)(gulp, "ngrok-serve", "start-ngrok", "manifest", "serve"));
};
exports.ngrokTasks = ngrokTasks;
